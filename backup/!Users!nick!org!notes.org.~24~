
#+TODO: TODO(t) WAIT(w@/!) | DONE(d!) CANCELED(c@)
#+SPDX-FileCopyrightText:bah blah
* Applying as contact tracer
** Different staffing agencies used by VA DOH:
*** 22nd Century - ended up not applying
*** @WORK Medical & Personnel Services
**** @WORK Medical & Personnel Services - couldn't find way to apply on their website!
*** Abacus Corporation [[https://www.abacuscorporation.com/]]  but goes to [[https://secure.jobappnetwork.com/apply/c_abacus/l_en/#s][this]] for application
**** DONE <2020-06-09 Tue> Apply
**** Applied for Case Investigator - Arlington
**** Applied for Contact Tracing Supervisor - Arlington
*** Ajilon - couldn't find any Virginia opportunities
*** Astyra - [[https://astyra.com]]
**** DONE <2020-06-09 Tue> Apply
**** Applied for Contact tracer
**** Received confirmation email
*** Athena Consulting https://athenaconsultingllc.com/
**** DONE Apply for Case Investigator <2020-06-10 Wed>
*** BizTek [[http://biztekpeople.com/]]
**** Was partway through submission for Case Investigator, submitted resume but then they asked for the Right to Represent thing, which I already signed for Athena.  They very clearly stated that I could only work with *one* recruiting agency, and I already told Athena they were the ones.  Well, I passed the test for BizTek, but to go any further I had to do the right to represent form so I stopped.
*** Cor-Tech / Caliper [[https://jobs.cor-tech.net]] or [[http://www.cor-tech.net/]]
**** DONE Apply for Case Investigator Manassass <2020-06-17 Wed>
*** Delta Group [[https://www.delta-tgroup.com/]] 
**** DONE Apply for Case investigator, Loudoun County <2020-06-17 Wed> 
**** They did not ask me (yet) for one of those Right to Represent things
**** Reveived email confirmation of submission
*** IPHI (Institute of Public Health Innovation (through TalentBoost at [[https://www.talentboost.cloud/iphi]]
**** DONE Apply for Community Health Worker Supervisor, Interviewer Supervisor, and Case Interviewer <2020-06-25 Thu>
- <2020-06-26 Fri> Still have heard nothing
*** Premier Staffing Source [[https://www.premierstaffingsource.com][Premier Staffing Source]]
**** DONE Apply to Premier Staffing <2020-06-26 Fri>
- Received message on screen "A recruiter will be in touch with you shortly."

** Following up:
*** TODO contact IPHI / TalentBoost
- To follow up on "Community Health Worker Supervisor with Institute for Public Health Innovation (IPHI)" application (Job # 618)
- IPHI contacts: 
  - phone: 202.747.3512 [[https://www.institutephi.org/contact-us/][contact page]]
  - email: info@institutephi.org - sent email <2020-06-26 Fri>
  - Haha who knows, here's their Twitter: @InstitutePHI
- Talentboost contact:
  - phone on main page: 617-542-1400
  - email: info@talentboost.us  - sent email <2020-06-26 Fri>
*** DONE Contact Athena Consulting 484-477-7747
- State "DONE"       from "TODO"       [2020-06-29 Mon 15:06]
- email of contact on VDH staffing agency list ([[https://www.vdh.virginia.gov/content/uploads/sites/182/2020/05/Staffing-Agency-List.pdf][here]]): melvin@athenaconsultingllc.com -- sent email <2020-06-26 Fri>
- phone on same list: 484-477-7747
- Recieved response <2020-06-28 Sun> that my stuff had been forwarded to VDH.  Thanked them!

** Cover sentence
I am trained as a physician, and I have worked extensively in public mental health.  I have experience working with patients in the community, traveling to their homes for in-person interviews and care. I have led clinical teams in both inpatient and outpatient settings. I believe that patients should feel that they are partners in their own care.

** Cover letter

Dear Recruiting team at Athena Consulting,

My name is Nicholas Taintor, and I am a physician living in Fairfax, Virginia.  I am writing to express my interest in the position of Case Investigator, with the Commonwealth of Virginia COVID-19 contact tracing effort.  I found notification of this position through the VDH website.

I believe that my medical and personal background makes me a strong candidate for this position.  I have spent my career learning how to conduct diagnostic and therapeutic interviews in a way that is empathic, sensitive, and mindful of confidentiality.  I understood early in my training that without a person's trust, there was little chance that they would follow my suggestions, no matter how correct or well-meant they might be.

I have a strong interest in medical informatics and have worked with a number of different electronic health record systems. I have contributed code and knowledge to a program helping to promote the use of the Veterans Administration electronic health record (VistA / CPRS) around the world.  These skills will help me document and present all of my interactions with, and findings from, persons believed to be infected with COVID-19.

In my view, the best kind of medicine and care happen when colleagues work with and learn from each other.  Helping to put a team together and learning how to work as a cohesive unit has always been my favorite part of any new job, and I look forward to being able to practice those skills. 

Although my residency training was in psychiatry, at New York University we were granted some leeway in our training.  Unlike most of my psychiatric colleagues, I asked for clinical rotations in medicine, infectious diseases, and oncology.  I spent three months working in the ICU at Bellevue Hospital helping to treat patients in advanced phases of illness.  I was the primary physician for a patient with one of the first locally-acquired cases of fulminant malaria seen in New York for years, and worked with epidemiologists to clarify the origins of that case. 

I have spent much of my medical career working in public health, and usually with people who are underserved by existing medical systems.  Learning how to earn the trust and partnership of people who might have a natural and understandable mistrust of medicine and authority is not easy or simple.  But it is the most important part of the process.

I trained at Bellevue Hospital in New York City, which is (in my view) the most vital public health institution in that city.  This is a place where people come when they do not have health insurance and often lack many other types of social support.  I learned from the best, there, about how to bring people in from the community and help them realize the ways in which they could get better.  I worked in the Free Clinic at Bellevue during medical school and residency and began to understand how to work with a diverse community of people who were very different from me.

Helping people to change their behavior is the basis of any worthwhile medical intervention.  Sometimes this is something simple, such as getting people to stop doing something that is hurting them such as smoking or excessive alcohol consumption.  At other times this is more complex - getting people to do something difficult and unpleasant with an unclear and distant payoff.  

During this COVID-19 pandemic, and as part of the contact tracing program, we will be asking people to isolate or quarantine themselves for the good of others.  This will require ongoing care and relationship-building with people who will be in a difficult and frightening situation - in a crisis, to put it simply.  I believe that my previous experience, along with my desire and willingness to learn more, will make me a valuable part of this program.

I will be ready to put my skills to work for the Commonwealth of Virginia, and more importantly to learn how I can contribute best to the effort.  I look forward to being a part of this important project.

I would like to thank you for taking the time to look through my application materials.


Nicholas Taintor

** From job overview for case investigator:
*** Core duties:
**** Interviewing and data collection
***** Communicates with contacts in professional and empathic manner
***** Collects and records information into statewide database
**** Heath Education
***** Provides cases with approved information about state isolation procedures and monitors compliance
***** Alerts epidemiologists if the case is associated with a congregate or other high-risk setting
***** Providing ill person with resources 
**** Data entry and maintenance
***** Uses established database(s) to identify newly diagnosed patients
***** Inputs data collected into database and keeps database up to date
***** Provides data from case investigation efforts to epidemiologists and / or Health Educators as necessary
*** KSAs
**** Knowledge of public health practices, communicable diseases, disease control, epidemiologic methods
**** Ability to manage, compile, analyze, and present data
**** Ability to communicate clearly both orally and in writing with diverse audiences
**** Ability to work with a variety of computer packages
**** Understanding of patient confidentiality
**** Excellent and sensitive interpersonal, cultural sensitivity, and interviewing skills to maintain trust with interviewees; judgement to refer cases if needed
* Messing with emacs-reveal
** Looks like I need to find a way to add that configuring javascript at the end
** Audio:
- Here's a way to change the audio config at the beginning:
#+begin_src 
# Set autoplay to true for audio plugin.
#+OER_REVEAL_AUDIO_SLIDESHOW_CONFIG: audioStartAtFragment: true, audio: { advance: -1, autoplay: true, defaultDuration: 0, defaultAudios: false, playerOpacity: 0.8, playerStyle: 'position: fixed; bottom: 9.5vh; left: 0%; width: 30%; height:30px; z-index: 33;' }

#+end_src

** Incorporating license data
**** Trying to figure out a way to:
Extract and put in license information in image metadata
   - Exiftool - FOSS, mac & Linux
   - mac CLI: [[https://exiftool.org/][exiftool]] - FOSS. =Brew install exiftool=
   - Ubuntu: =sudo apt install libimage-exiftool-perl=
   - Here's an example of how to put information into an image using =exiftool=:
#+begin_src bash
exiftool -ImageDescription="This is an image from the book Frankiesaurus and the Helpful Spider" -Artist="Nick Taintor" \
> -Copyright="This work is licensed under the Creative Commons Attribution ShareAlike 4.0 International License. \
dquote> To view a copy of this license, visit http://creativecommons.org/licenses/by-sa/4.0/ or send a \
dquote> letter to Creative Commons, PO Box 1866, Mountain View, CA 94042 USA." \
-XMP-cc:License="http://creativecommons.org/licenses/by-sa/4.0/" okpops.png
#+end_src
**** Here's a package that could be useful:
[[https://github.com/emacsmirror/exiftool][exiftool.el]] is an elisp wrapper around ExifTool

**** emacs-reveal .meta file components:
example: 
((filename . "./figures/data-structures/block-chain.png")
 (licenseurl . "https://creativecommons.org/licenses/by-sa/4.0/")
 (licensetext . "CC BY-SA 4.0")
 (cc:attributionName . "Jens Lechtenbörger")
 (cc:attributionURL . "https://gitlab.com/lechten")
 (dc:source . "https://gitlab.com/oer/figures/blob/master/data-structures/tikz/block-chain.tex")
 (sourcetext . "GitLab")
 (dc:title . "Block chain of transactions")
 (texwidth . 0.9)
)



3) develop a workflow to put that information into an emacs-reveal .meta file
* Background checks
** DONE hireright confirmation # 02328936 said 15 days
- State "DONE"       from "TODO"       [2020-07-07 Tue 11:37]
- Received response <2020-07-21 Tue> that they had no record of anyone requesting info from them, so nothing to give me
** Allegedly nothing at Empinfo
** Kept getting errors with Equifax
** DONE PeopleFacts
- State "DONE"       from "TODO"       [2020-07-07 Tue 11:54]
- Response one week later - "unable to locate a report"
** DONE InfoCubic
- State "DONE"       from "TODO"       [2020-07-07 Tue 12:00]

* CompTIA class site
- <2020-07-11 Sat> temporarily running it under frankie.monster, having some weird issues with my pepsidotcom.com url  **resolved**
- <2020-07-16 Thu> now living at *index.org* in *sessionone* directory, straight export to HTML
- 
* Eternal Terminal ([[https://eternalterminal.dev/][site]])
(Remote terminal for the busy and impatient)
** Macos:
- =brew install MisterTea/et/et=
** Ubuntu:
- =sudo apt-get install -y software-properties-common=
- =sudo add-apt-repository ppa:jgmath2000/et=
- =sudo apt-get update=
- =sudo apt-get install et=
  - open port 2022/TCP (default =et= port)
** Use:
=et user@hostname[:port]=
ET will automatically use the =ssh_config= file when making connections
** Then I started getting these errors (only when trying to connect to dudley, not falkie):
#+begin_src bash
[INFO 2020-10-15 06:47:21,575 client-main TerminalClientMain.cpp:172] Parsed ssh config file, connecting to brainsled.xyz
[V1 2020-10-15 06:47:21,575 client-main TerminalClientMain.cpp:11] Connecting
[INFO 2020-10-15 06:48:36,694 client-main TcpSocketHandler.cpp:59] Error connecting with brainsled.xyz: 60 Operation timed out
[ERROR 2020-10-15 06:48:36,841 client-main TcpSocketHandler.cpp:140] Stack Trace:
[0] 0x0000000101e06516 et::TcpSocketHandler::connect(et::SocketEndpoint const&)
[1] 0x0000000101da0c95 ping(et::SocketEndpoint, std::__1::shared_ptr<et::SocketHandler>)
[2] 0x0000000101da349e main
[3] 0x00007fff686e3cc9 start
[4] 0x0000000000000006 0x0
ERROR, no host found
[V1 2020-10-15 06:48:36,841 client-main TerminalClientMain.cpp:14] Could not connect to host
Could not reach the ET server: brainsled.xyz:2022
#+end_src
* Matrix/Jitsi
** Jitsi on its own
*** [[https://jitsi.github.io/handbook/docs/devops-guide/devops-guide-quickstart][Jitsi self-hosting guide]]
*** In =LXC=:
**** put the FQDN in the =/etc/hosts= file, in the =jitsi= LXC container
- and using =hostnamectl=: =sudo hostnamectl set-hostname jitsi=
**** <2020-10-14 Wed 16:31> trying to set up jitsi-meet on dudley with =jitsi.fob.monster=
1. FQDN defined in /etc/hosts and =hostnamectl=
2. Jitsi LXC installed with LXC profile jitsi-profile, which:
   1. has =gnupg2=, =build-essential=, =nginx=, =nginx-common=, and =apt-transport-https= already installed
3. Apache2 already installed:
   =apt install apache2=
4. /After/ Jitsi install, changed Apache config at =/etc/apache2/apache2.conf= (actually didn't have to change)
5. Put this in =/etc/jitsi/videobridge/sip-communicator.properties=:
   #+begin_src bash
org.ice4j.ice.harvest.NAT_HARVESTER_LOCAL_ADDRESS=10.215.36.63
org.ice4j.ice.harvest.NAT_HARVESTER_PUBLIC_ADDRESS=45.79.138.21
org.jitsi.videobridge.NAT_HARVESTER_LOCAL_ADDRESS=10.215.36.63
org.jitsi.videobridge.NAT_HARVESTER_PUBLIC_ADDRESS=45.79.138.21
   #+end_src
  *and* comment out =org.ice4j.ice.harvest.STUN_MAPPING_HARVESTER_ADDRESSES==blahblah
   (is supposed to be ~LOCAL_ADDRESS=[localip]~ and ~PUBLIC_ADDRESS=FQDN~, I /think/)
6. security through HAProxy, not the Jitsi nginx - but it needs you to set up a certificate in the install so I selected generate self-signed
7. ports 80 and 443 and 4443 through HAProxy but from haproxy goes to :80 - if I try to send it through :443 in haproxy.cfg, "server unavailable"
8. port 10000/udp through LXC device configure
   Issues: couldn't complete connection through firefox, error "the page isn't redirecting properly" - 301 with =curl=
   solution: add =http-response replace-value Set-Cookie (.*) 1; Secure= to frontend
     When testing with just an nginx server (before installing jitsi-meet), needed to have nginx listen on port 443 - set in =/etc/nginx/sites-available/jitsi.fob.monster.conf=

     looking at jitsi-meet.conf in =/usr/share/jitsi-meet-turnserver=

**** Steps from [[https://community.hetzner.com/tutorials/jitsi-meet-on-debian-ubuntu][Hetzner tutorial]]:
1. add repository,update, install =apt-transport-https=
2. configure hostname - they say =hostnamectel set-hostname talk=, i.e. just the first part of the FQDN.  Also to put =talk.example.com= in =/etc/hosts=, i.e. the FQDN there
3. Install webserver first - they say =apt-get install nginx -y=, to avoid problems with the server Jitsi installs - nginx or jetty
4. Install jitsi meet - =apt-get install jitsi-meet -y=, select self-signed certificate
5. Modify shipped nginx config - =/etc/nginx/sites-available/talk.example.conf=, for us =/etc/nginx/sites-available/meet.fob.monster=
   - remove lines starting with =ssl_certificate= and =ssl_certificate_key=, replace with
     #+begin_src bash
ssl_certificate /etc/letsencrypt/live/talk.example.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/talk.example.com/privkey.pem;
ssl_trusted_certificate /etc/letsencrypt/live/talk.example.com/chain.pem;
     #+end_src
   - [could put in IPv6 support here]
   - Change TLS configuration - replace line starting with =ssl_protocols= with =ssl_protocols TLSv1.2 TLSv1.3;=
6. in =/etc/jitsi/meet/jitsi.fob.monster-config.js=:
   - uncomment and change =// disableThirdPartyRequests: false= to =true=
   - add more than one STUN server under =stunServers= (list available at this [[https://gist.github.com/mondain/b0ec1cf5f60ae726202e][Github gist]]).  (could someday host our own [[https://community.hetzner.com/tutorials/install-turn-stun-server-on-debian-ubuntu-with-coturn][coturn server]]) Suggested by Hetzner:
     #+begin_src bash
{ urls: 'stun:stun.nextcloud.com:443' },
{ urls: 'stun:stun.stunprotocol.org:3478' },
{ urls: 'stun:meet-jit-si-turnrelay.jitsi.net:3478' }
     #+end_src
7. Then restart everything =systemctl restart nginx.service jicofo.service jitsi-videobridge2.service=

**** from this useful [[https://www.reddit.com/r/jitsi/comments/if5gdv/guide_to_installuse_jitsi_in_an_lxd_container/][reddit post]]:
1. points out utility of =echo 'export EDITOR=nano' >> ~/.profile= in LXC host
2. make new LXD profile:
   - =lxc copy default jitsi-profile=
   - =lxc profile edit jitsi-profile=
   - His profile suggestion:
     #+begin_src yaml
config:
  user.network-config: |
    version: 2
    ethernets:
      eth0:
        addresses:
        - 192.168.1.200/32
        nameservers:
          addresses:
          - 8.8.8.8
          search: []
        routes:
        -   to: 0.0.0.0/0
            via: 169.254.0.1
            on-link: true
description: Default LXD profile
devices:
  eth0:
    ipv4.address: 192.168.1.200  # or whatever you choose (this will be the ip address of the container)
    nictype: routed
    parent: enp6s0  # change to name of host nic, i.e. eth0 or whatever it is
    type: nic
name: # [can't change this anyway]
used_by: # or this, either I think 
     #+end_src
3. Create new LXD container, can *add* the new profile to =default= - wow, I didn't know that!
4. So, could be:
   =lxc launch ubuntu:20.04 jitsi --profile default --profile jitsi-profile=
5. Look it over with =lxc list=
6. Then follow the [[https://jitsi.github.io/handbook/docs/devops-guide/devops-guide-quickstart][same Jitsi guide]] I've been using, with these changes:
   - if behind a proxying server (which I guess HAProxy counts as?) remove =/etc/nginx/modules-enabled/60-jitsi-meet.conf=
   - Then go to /etc/nginx/sites-available/your-conf and change it to listen on 443 instead of 4444 and restart nginx
7. And there we go!     

     
**** <2020-10-14 Wed 20:18> trying this out of desperation and fatigue: https://jitsi.github.io/handbook/docs/devops-guide/devops-guide-docker
(instead I couldn't get it to work - and used up my letsencrypt allowance! Problem seemed to have to do with jvb not making connections.  I think the docker implementation is still a bit of a mess, and honestly LXC really seems like a better choice.  Integrating those many parts may be beyond a pre-designed docker-compose setup.  I'm more of a fan of [[https://git.luddites.tech/ludd/deployments/src/branch/main/traefik/apps/jitsi/docker-compose.yml][this guy's]] docker-compose setup with Traefik v2.  If anything could work, maybe this - he said it did in Sept)

<2020-10-15 Thu 04:29>I think the key will be this guy's use of Apache with HAProxy instead of Nginx - [[https://forum.netgate.com/topic/152738/jitsi-ssl-offload-haproxy-not-working/3][here]].  Seems like all the redirects I was having might be due to the https redirection setup by the Jitsi install.  I'll try his tomorrow!

dealing with this: =Error binding encrypted port for https: No certificate present in SSL/TLS configuration for https port 5281= in prosody logs
- Dealt with that by uncommenting =https_ports = { }= in file =/etc/prosody/conf.d/jitsi.fob.monster.cfg.lua= - really just blocks the error messages, turns out they do not reflect an underlying problem as discussed [[https://community.jitsi.org/t/no-certificate-present-in-ssl-tls-configuration-for-https-port-5284/47836/6][here]].

added =xmpp= to this line ~JVB_OPTS="--apis=xmpp,"~ in =/etc/jitsi/videobridge/config= to address crashing when users join, mentioned [[https://wiki.archlinux.org/index.php/Jitsi-meet#Tips_and_tricks][here]]

BOSH check works - =https://jitsi.fob.monster/http-bind= - "It works!"

Did a =diff= of the example Apache conf file and =/etc/apache2/sites-available/jitsi.fob.monster.conf= - no differences, only in host names

**** Remove all jitsi-meet components:
apt-get purge jigasi jitsi-meet jitsi-meet-web-config jitsi-meet-prosody jitsi-meet-turnserver jitsi-meet-web jicofo jitsi-videobridge
** sources for build with Docker:
- using mostly [[https://dev.to/joenas/matrix-homeserver-synapse-v09911-with-traefik-35ja][Jon Neverland's build]], but his model was built with Traefik 1.0
- Also, I put all the various accompanying directories right off ~/docker/containers/matrix rather than off /opt/matrix the way he did
- will install ma1sd identity server from its [[https://github.com/ma1uta/ma1sd][Github repo]]
  - (but will do it later - will probably need to add =m.identity_server= in =./matrix/nginx/www/.well-known/matrix/client=)
** jitsi components to stop / restart:
prosody
jicofo
jitsi-videobridge2
** trying a thing <2020-07-27 Mon>
- Trouble (seems) to be with videobridge.  When I exec'd into the container yesterday, ~/etc/init.d/jitsi-videobridge2 status~ returned FAIL
- I could restart it manually within the container, but what's the point?
- Followed various Github issues, including [[https://github.com/jitsi/docker-jitsi-meet/issues/573][this one]], but my issue still not resolved
- So I decided I would build the whole thing on metal on Dudley so that I can compare things.
- Using [[https://matrix.org/blog/2020/04/06/running-your-own-secure-communication-service-with-matrix-and-jitsi][this]] off the main matrix site, following their Debian installation guide
- following instructions [[https://github.com/matrix-org/synapse/blob/develop/docs/postgres.md][here]] to change synapse database to postgres
- seemed to work; had to put =server_name= in homeserver.yaml
** setting up secured site
- mostly from [[https://crosstalksolutions.com/how-to-enable-jitsi-server-authentication/][here]]
- =sudo prosodyctl register nick jitsi.brainsled.xyz bannanablanketsmoke=
- bannanablanketsmoke
** Back to trying Jitsi with Docker
- <2020-07-30 Thu> Based on [[https://community.jitsi.org/t/traefik-and-docker-install/23551/42][this jitsi.org thread]] (last post May 27th) a fundamental problem is getting jvb to work over UDP with Traefik
  - But keep looking at that thread and successors
** So the question that goes through my mind now is:
- can we figure out a way to have matrix / jitsi baremetal and traefik live together?
** Trying to set it all up behind Traefik
*** Ports needed for jitsi:
- (seem to no longer need whole UDP range 10000-20000)
- =80 TCP= - SSL certificate verification / LE renewal
- =443 TCP= - general access to Jitsi Meet
- =4443 TCP= - fallback network video / audio communications (i.e. when UDP is blocked)
- =10000 UDP= - general network video/audio communications
*** setting up port intercept / diversion in traefik dynamic conf:
#+begin_src yaml
http:
  routers:
    jitsi_router:
      entryPoints:
        - "websecure"
      rule: "Host(`jitsi.brainsled.xyz`)"
      service: "jitsi_service"
      tls:
        certResolver: "letsencrypt"

  services:
    jitsi_service:
      loadBalancer:
        passHostHeader: true
        servers:
          - url: "http:45.79.138.21:4444"
#+end_src
*** setting up custom port location in jitsi conf files
**** in =/etc/nginx/sites-available/jitsi.brainsled.xyz.conf=
- /change all =80= to 4442/ - undone <2020-09-23 Wed>
- change all =443= to 44443
- server name is =jitsi.brainsled.xyz=
**** in =/etc/jitsi/meet/jitsi.brainsled.xyz-config.js=
- change =bosh= lines:
  - =bosh: '//jitsi.brainsled.xyz:44443/http-bind',=
  - =return 301 https://$host:44443/$request_uri;=
**** seeing what is listening to ports:
- =sudo netstat -plnt=
- filter to things listening to port 80:
  - =sudo netstat -plnt | grep ':80'=
*** error: no valid ssl cert
- this cert problem seemed to be from Traefik trying to talk to jvb over HTTP.
- I put =insecureSkipVerify: true= into static config.
  - This is said to have security implications, namely that it leaves you open to MITM attacks.  But since both processes are in the same machine, I'm less worried about this.
  - However, will need to fix!
  - Presumably by figuring out how to give the jitsi stuff its own internal cert?
*** <2020-09-23 Wed> now running, sort of -
- stuff comes up but connection is dropped in a few minutes, no one can join
- This all looks oddly familiar, and I believe is due to no connection being made over port 10000 to jvb.
  - Will need to figure out how to forward port 10000 through Traefik.  Currently only 443 going through.

* LXC / LXD
** cloud-init
- want to use an image that is set up for cloud-init, so we can set a custom network configuration - supposedly all the ones on =ubuntu:= are set up with =cloud-init= (i.e. not necessarily the ones on =images:=)
  - Though it looks like now the ones on =images:= have versions with =cloud-init= support, with the alias =/cloud=
  - so you can find them with =lxc image list images:ubuntu/focal/cloud= for example
- once again, using [[https://blog.simos.info/how-to-preconfigure-lxd-containers-with-cloud-init/][Simos' blog]] to help with this
** first, set up a cloud-init profile
*** look at pre-existing profiles:
=lxc profile list=
*** probably only default, so
=lxc profile copy default [new profile]=
or,
=lxc profile copy default jitsi-profile=
*** (don't forget =export EDITOR=nano=)
*** then,
=lxc profile edit jitsi-profile=
- change the =description=
- for now, leave =devices= as it is
  - (can't change =name=)
*** Here's a profile file:
#+begin_src yaml
config:
  user.user-data: |
    #cloud-config
    package_upgrade: true
    packages:
      - build-essential
      - nginx
      - nginx-common
      - gnupg2
      - apt-transport-https
      - net-tools
    locale: es_ES.UTF-8
    timezone: America/New_York
    runcmd:
      - [touch, /tmp/nick_was_here]
description: Jitsi-Meet profile
devices:
  eth0:
    name: eth0
    network: lxdbr0
    type: nic
  root:
    path: /
    pool: lxc_pool
    type: disk
name: jitsi-profile
used_by: []
#+end_src
* HAProxy & LXD
- Since I feel like Jitsi & Matrix work better (for me, anyway) as a non-Dockerized service and I'm having trouble setting them up behind Traefik that way, and it's hard to figure out how to share ports 80 and 443, how about running Jitsi / Matrix in a linux container and having HAproxy decide which packets go where?  Why not indeed?
*** Installing LXD
- [[https://blog.simos.info/how-to-initialize-lxd-again/][This]] is a helpful website for dealing with some of the errors I had.
- [[https://linuxcontainers.org/lxd/][The main pages for LXD and LXC]]
- LXD = container hypervisor
  - /install: =sudo apt install lxd= - (select 4.0)/
  - <2020-09-27 Sun> now using snap instead - don't use the PPA!
    - turns out need to install 4.0 channel specifically, and more specificaly 4.6):
      - =snap install lxd --channel=4.6/stable=
        - and to update from earlier channels if you installed them, =sudo snap refresh --channel=4.6/stable lxd=
  - Need to enable swap accounting, done by:
    - appending =swapaccount=1= to =GRUB_CMDLINE_LINUX_DEFAULT= variable in =/etc/default/grub=
    - Had to check around exactly what they meant by "append," seems to work as this but will check after:
      - ~GRUB_CMDLINE_LINUX_DEFAULT="quiet splash swapaccount=1"~
      - ("quiet" and "splash" have to do with the first screens shown by GRUB, and are not germane to any of this)
      - After making that change, =sudo update-grub= and =reboot=
- =lxd init= must be run by root, =lxc= commands can be run by anyone who is a member of the group =lxd=
  - =sudo usermod -a -G group1,group2,group3 username= to make a user part of a group
  - =sudo usermod -a -G lxd nick= to make /me/ part of =lxd=
- checking on versions installed:
  - =lxc --version=
  - =lxd --version=
- An error that came up one of the first times I tried this: =sudo dd if=/dev/zero of=/dev/sdc4 count=64 bs=1024= when error creating zfs pool, =device or resource busy= and =one or more vdevs refer to the same device, or one of the devices is part of an active md or lvm device=.
- Actually, the key to that error seems to have been that I can /create/ the partition but not format it.  LXD wants to format it.  If I had already formatted it, it is seen as "in use."  They could have explained /that/ better!
- Looking at the zpool drives: =sudo zpool status=
*** Putting up an instance
1. ~instances~ based on ~images~
2. find a 64-bit debian 10 image (for example):
   - =lxc image list images: debian/10 amd64=
3. Launching the instance: =lxc launch images:debian/10 debian=
*** Using [[https://autoize.com/lxc-lxd-containers-with-haproxy/][these instructions]] as a base to set up a practice session on =dudley=
**** start with =snap install lxd=
**** add user to lxd user group:
=usermod -aG lxd [user]=
**** set up lxd:
=sudo lxd init=
[in this case, will use a zfs loop device (on =falkie= will use a block device)
**** set up web containers
=lxc launch ubuntu:20.04 web1=
=lxc launch ubuntu:20.04 web2=
=lxc launch ubuntu:20.04 haproxy=
**** point Linode DNS provider to FQDN of test containers (in this case used =web1= and =web2=)
**** set up =nginx= in each web container
- drop into first container =web1=
  - =lxc exec web1 /bin/bash=
  - =apt update && apt dist-upgrade && apt-get install nginx-common libnginx-mod-rtmp -y=
  - =apt-get install nginx -y=
  - =systemctl enable nginx=
  - =systemctl start nginx=
  - edit =/var/www/html/index.nginx-debian.html=
    - =nano -c /var/www/html/index.nginx-debian.html=
    - change line 4 to =web1= (or web2) =works!=
- do the same for =web2=
**** forward :80 and :443 and udp :10000 from host to =haproxy= container
- =lxc config device add haproxy http proxy listen=tcp:0.0.0.0:80 connect=tcp:127.0.0.1:80=
- =lxc config device add haproxy https proxy listen=tcp:0.0.0.0:443 connect=tcp:127.0.0.1:443=
[this creates a TCP to TCP proxy device]
- here's a format for UDP proxy (needed for port 10000 in Jitsi):
  - =lxc config device add jitsi jitsiudp10000 proxy listen=udp:0.0.0.0:10000 connect=udp:127.0.0.1:10000=
  - =listen=udp:0.0.0.0:10000= /listens/ on the host on all network interfaces with UDP port 10000
  - =connect=tcp:127.0.0.1:10000= /connects/ to the container to existing port 10000 on localhost
  - However, I think would need to forward the udp to the /jitsi/ container rather than the haproxy - haproxy wouldn't know what to do with udp packets.
    - so would probably be =...device add jitsi...= instead
  - [[https://blog.simos.info/how-to-use-the-lxd-proxy-device-to-map-ports-between-the-host-and-the-containers/][reference I used for this]]
- stuff about haproxy and =proxy_protocol= [[https://www.haproxy.org/download/1.8/doc/proxy-protocol.txt][here]]
- [[https://www.linode.com/docs/applications/containers/beginners-guide-to-lxd-reverse-proxy/][this]] is also a good guide from Linode, setting up multiple websites on LXD without using HAProxy, using LXD and nginx as reverse proxy to apache websites
**** set up the =haproxy= container:
- =lxc exec haproxy /bin/bash=
- root@haproxy:~# =apt update && apt upgrade=
- (staying in =haproxy= container)
- =apt install haproxy=
- =systemctl enable haproxy=
- =systemctl start haproxy=
(installing certbot for nginx)
- =snap install --classic certbot=
- =sudo certbot --nginx=
(though, may want to use [[https://github.com/go-acme/lego#installation][lego]]? Above two options won't let me install wildcard certificates yet)
- <2020-09-27 Sun> stopped here, <2020-09-27 Sun 20:57> stopped here again (about to install =lego=, didn't try certbot)

** using LXD container hostnames - a kind of local DNS
- =ip addr show dev lxdbr0= (to show the data for the LXD bridge set up during =lxd init=)
- =dnsmasq= in LXD needs to understand that it is the authoritative DNS server for the LXD domain
- but we want to avoid a DNS loop!
  - so we add =dns-loop-detect= which dtects DNS loops by sendng TXT queries to each server; if they boomerang then the upstream server is disabled.  Test runs each time bridge is enabled; in this case at LXD startup.
  - =echo -e "auth-zone=lxd\ndns-loop-detect" | lxc network set lxdbr0 raw.dnsmasq -=
- =sudo systemd-resolve --interface lxdbr0 --set-dns 10.215.36.1 --set-domain lxd=
  - this sets the DNS server for =lxdbr0= to the ip address of =lxdbr0=
  - specifies domain as =lxd=
  - check that it worked with =systemd-resolve --status lxdbr0=
- There is more to look at here - [[https://blog.simos.info/how-to-use-lxd-container-hostnames-on-the-host-in-ubuntu-18-04/][using LXD hostnames]]
- I'm not sure I need this ability yet
** Static IPs for containers
- see [[https://github.com/lxc/lxd/issues/2083][here]], last reply, for reference to setting up static IPs - will need cloud-init ready images though.
* Getting letsencrypt certs for HAProxy
** using =certbot=:
*** setting up certbot:
- =service haproxy stop= (need to free up :80 and :443)
- =add-apt-repository ppa:certbot/certbot=
- =apt update=
- =apt install certbot=
*** obtaining certificates:
- (do all this in the HAProxy LXC container, if using that)
- (will need to stop anything using ports :80 or :443, i.e. =systemctl stop haproxy=)
- =certbot certonly=
- select (1) - spin up temporary webserver
- enter FQDNs, separated by comma and space
- will tell you where the certs are stored
  - in this case, at
    - certificate and chain at =/etc/letsencrypt/live/jitsi.brainsled.xyz/fullchain.pem= and
    - keyfile at =/etc/letsencrypt/live/jitsi.brainsled.xyz/privkey.pem=
- then combine the two files =fullchain.pem= and =privkey.pem= into single file at =/etc/haproxy/certs=
  - =mkdir -p /etc/haproxy/certs=
  - =cat /etc/letsencrypt/live/jitsi.brainsled.xyz/fullchain.pem /etc/letsencrypt/live/jitsi.brainsled.xyz/privkey.pem > /etc/haproxy/certs/jitsi.brainsled.xyz.pem=
  - <2020-10-09 Fri> also put in certs for =brainsled.xyz=

** run this to download and extract =golang= and install =lego=
- don't mess around with the =go= installation, easiest and most reliable way seems to be:
  - downloading the correct package from [[https://github.com/go-acme/lego/releases][the lego releases page]], which in this particular case on <2020-09-28 Mon> is:
  - =wget https://github.com/go-acme/lego/releases/download/v4.0.1/lego_v4.0.1_linux_amd64.tar.gz=
  - then =tar -xzvf lego_v4.0.1_linux_amd64.tar.gz= (or whatever the filename turns out to be 
**  put =LINODE_TOKEN= in =/etc/environment= /in/ HAProxy LXC, since that's where we'll be getting certs from
- But then for some reason storing the variable in =/etc/environment= wasn't working, so I did this:
  - ~LINODE_TOKEN=[LINODE token]~ to get it in for that session
  - ~LINODE_TOKEN=$LINODE_TOKEN ./lego --email="nick.taintor@gmail.com" --domains="*.frankiesaurus.com" --dns="linode" run --run-hook="./myscript.sh"~
    - (but couldn't get =myscript.sh= to take - that's where =lego= is supposed to record some things)
    - certificate is at =root/.lego/accounts=
** Turns out HAProxy has its own mechanism for this?
*** Looking [[https://www.haproxy.com/blog/lets-encrypt-acme2-for-haproxy/][here]]
*** Well, maybe some other time.
*** use ~proxy_protocol~!
** Trying =certbot= again:
*** =snap install --classic certbot=
*** =certbot certonly --manual --preferred-challenges dns --server https://acme-v02.api.letsencrypt.org/directory --manual-public-ip-logging-ok -d '*.<your.domain>' -d <your.domain>=
** Then, 
- put the code in the DNS server (Linode, for me) under the hostname =_acme-challenge.brainsled.xyz=
- Wait 5 minutes, assuming you remembered to put 5 min TTL!
** Success!  stored at
- =/etc/letsencrypt/live/brainsled.xyz/fullchain.pem=
- =/etc/letsencrypt/live/brainsled.xyz/privkey.pem=
** Then concatenate the results into something that HAProxy can understand:
- =cat fullchain.pem privkey.pem > brainsled.xyz.pem=
** =nano /etc/haproxy/haproxy.cfg=
** edit this in:
#+begin_src bash
global
	maxconn	1000
	log /dev/log	local0
	log /dev/log	local1 notice
	chroot /var/lib/haproxy
	stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
	stats timeout 30s
	user haproxy
	group haproxy
	daemon

	# Default SSL material locations
#	ca-base /etc/ssl/certs
#	crt-base /etc/ssl/private

	# See: https://ssl-config.mozilla.org/#server=haproxy&server-version=2.0.3&config=intermediate
#        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
#        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
#        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
	log	global
	mode	http
	option	httplog
	option	dontlognull
	option	forwardfor
	option	http-server-close
        timeout connect 5000
        timeout client  50000
        timeout server  50000
	errorfile 400 /etc/haproxy/errors/400.http
	errorfile 403 /etc/haproxy/errors/403.http
	errorfile 408 /etc/haproxy/errors/408.http
	errorfile 500 /etc/haproxy/errors/500.http
	errorfile 502 /etc/haproxy/errors/502.http
	errorfile 503 /etc/haproxy/errors/503.http
	errorfile 504 /etc/haproxy/errors/504.http

listen stats
	bind *:8404
	mode http
	stats enable
	stats show-legends
	stats uri /stats
	stats refresh 10s

frontend www_frontend
    mode http
    bind *:80
    bind *:443 ssl crt /etc/haproxy/certs/
    http-request redirect scheme https unless { ssl_fc }
    http-request set-header X-Forwarded-For %[src]
    http-request add-header X-Forwarded-Proto https if { ssl_fc }
    option http-server-close

    acl host_jitsi hdr(host) -i jitsi.brainsled.xyz
    acl host_web2 hdr(host) -i web2.brainsled.xyz
    acl haproxy_stats hdr(host) -i haproxy.brainsled.xyz

    use_backend haproxy_stats if haproxy_stats
    use_backend jitsi_cluster if host_jitsi
    use_backend web2_cluster if host_web2

backend jitsi_cluster
    balance leastconn
    # We set the X-Client-IP HTTP header. This is useful if we want the web server to know the real client IP.
    http-request set-header X-Client-IP %[src]
    # This backend, named here "jitsi", directs to container "jitsi.lxd" (hostname).
    server jitsi jitsi.lxd:80 check

backend web2_cluster
    balance leastconn
    http-request set-header X-Client-IP %[src]
    server web2 web2.lxd:80 check

backend haproxy_stats
    balance leastconn
    http-request set-header X-Client-IP %[src]
    server haproxy haproxy.lxd:8404 check
#+end_src
** Then,
- save and close, restart HAProxy:
- =# systemctl restart haproxy=
** =http://web1.brainsled.xyz= should work

* HAProxy again
** LXD Proxy Device to map ports between the host and the containers
*** this seems important:
- [[https://blog.simos.info/how-to-use-the-lxd-proxy-device-to-map-ports-between-the-host-and-the-containers/][from Simos' blog]] - connecting TCP to TCP, UDP to UDP, etc /without/ using =iptables=
** Trying through [[https://kifarunix.com/install-and-setup-haproxy-on-ubuntu-20-04/][this set of instructions]]
- there is an "SSL pass through" - which is documented [[https://www.haproxy.com/documentation/haproxy/deployment-guides/tls-infrastructure/#ssl-tls-offloading][here]] and a discussion of it on this [[https://scriptthe.net/2015/02/08/pass-through-ssl-with-haproxy/][blog]]
  - HAProxy runs in =tcp= mode, passes through SSL/TLS requests
- update to latest version
  - =add-apt-repository ppa:vbernat/haproxy-2.2 --yes=
** in =dudley=:
- (could use =lxc config=, I think, to do this as well, but will try with =iptables= first)
- using iptables to forward ports from host to HAProxy container (using ip address from =lxc list=:
  - =sudo iptables -t nat -I PREROUTING -i eth0 -p TCP -d 45.79.138.21/32 --dport 80 -j DNAT --to-destination 10.215.36.245:80=
  - =sudo iptables -t nat -I PREROUTING -i eth0 -p TCP -d 45.79.138.21/32 --dport 443 -j DNAT --to-destination 10.215.36.245:443=
  - to keep persistent: =sudo apt-get install iptables-persistent=
    - (keeps persistent through reboots but still need to update them after change)
- <2020-10-06 Tue> removing iptables, found out how to use lxc configure to proxy udp ports
** this seems to work so far <2020-10-02 Fri 15:56>, but /no/ security yet enabled
** enabling stats
- don't need nginx installed to serve - tested first /with/ nginx but then purged it
- add this to =/etc/haproxy/haproxy.cfg=:
#+begin_src bash
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST
#+end_src
- access stats from command line /if/ in haproxy container:
  - =echo "show info" | socat stdio /run/haproxy/admin.sock=
- access in browser with =http://haproxy.brainsled.xyz/stats=
** <2020-10-09 Fri 19:24> current haproxy.cfg on =dudley= SSL working
#+begin_src bash
global
	maxconn	1000
	log /dev/log	local0
	log /dev/log	local1 notice
	chroot /var/lib/haproxy
	stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
	stats timeout 30s
	user haproxy
	group haproxy
	daemon

	# Default SSL material locations
#	ca-base /etc/ssl/certs
#	crt-base /etc/ssl/private

	# See: https://ssl-config.mozilla.org/#server=haproxy&server-version=2.0.3&config=intermediate
#        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
#        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
#        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
	log	global
	mode	http
	option	httplog
	option	dontlognull
	option	forwardfor
	option	http-server-close
        timeout connect 5000
        timeout client  50000
        timeout server  50000
	errorfile 400 /etc/haproxy/errors/400.http
	errorfile 403 /etc/haproxy/errors/403.http
	errorfile 408 /etc/haproxy/errors/408.http
	errorfile 500 /etc/haproxy/errors/500.http
	errorfile 502 /etc/haproxy/errors/502.http
	errorfile 503 /etc/haproxy/errors/503.http
	errorfile 504 /etc/haproxy/errors/504.http

listen stats
	bind *:8404
	mode http
	stats enable
	stats show-legends
	stats uri /stats
	stats refresh 10s

frontend www_frontend
    mode http
    bind *:80
    bind *:443 ssl crt /etc/haproxy/certs/
    http-request redirect scheme https unless { ssl_fc }
    http-request set-header X-Forwarded-For %[src]
    http-request add-header X-Forwarded-Proto https if { ssl_fc }
    option http-server-close

    acl host_jitsi hdr(host) -i jitsi.brainsled.xyz
    acl host_web2 hdr(host) -i web2.brainsled.xyz
    acl haproxy_stats hdr(host) -i haproxy.brainsled.xyz

    use_backend haproxy_stats if haproxy_stats
    use_backend jitsi_cluster if host_jitsi
    use_backend web2_cluster if host_web2

backend jitsi_cluster
    balance leastconn
    # We set the X-Client-IP HTTP header. This is useful if we want the web server to know the real client IP.
    http-request set-header X-Client-IP %[src]
    # This backend, named here "jitsi", directs to container "jitsi.lxd" (hostname).
    server jitsi jitsi.lxd:80 check

backend web2_cluster
    balance leastconn
    http-request set-header X-Client-IP %[src]
    server web2 web2.lxd:80 check

backend haproxy_stats
    balance leastconn
    http-request set-header X-Client-IP %[src]
    server haproxy haproxy.lxd:8404 check
#+end_src
** validate =haproxy.cfg= file:
=sudo haproxy -f /etc/haproxy/haproxy.cfg -c=
** Mixing SSL termination and pass-through in HAProxy
*** Found what looks like an elegant solution to this [[https://discourse.haproxy.org/t/mixing-mode-tcp-and-http-ssl-termination-and-passthrough/2698/16][here]].
- concatenating a backend and a frontend
**** Here's what he said:
- 
#+begin_src bash
#######haproxy.cfg_BEGIN##################
…
…
frontend SSL_PassThrough
mode tcp
bind *:80
bind *:443
tcp-request inspect-delay 5s
tcp-request content accept if { req_ssl_hello_type 1 }

use_backend backend1 if { req_ssl_sni -i aaa.bbb.com }
use_backend backend2 if { req_ssl_sni -i ccc.ddd.com }
use_backend bbackend3 if { req_ssl_sni -i eee.fff.com }
default_backend bk_tcp_to_https

backend bk_tcp_to_https
mode tcp
server haproxy-https 127.0.0.1:8443 check

frontend SSL_Termination
mode http
bind *:8443 ssl crt /etc/haproxy/certs/ggg.hhh.com.pem crt /etc/haproxy/certs/iii.kkk.com.pem

use_backend     backend4  if { hdr(host) -i ggg.hhh.com }
use_backend     backend5  if { hdr(host) -i iii.kkk.com }

#SSL Passthrough Backends (every backend manage their own SSL termiantion)
backend backend1
mode tcp
server server1 192.168.0.100:443 check

backend backend2
mode tcp
server server2 192.168.0.101:443 check

backend backend3
mode tcp
server server3 192.168.0.102:443 check

#SSL Terminated by HAProxy Backends (plain http traffic between HAProxy and these backends)
backend backend4
mode http
server server4 192.168.0.104:80 check
http-request set-header X-Forwarded-Port %[dst_port]
http-request add-header X-Forwarded-Proto https if { ssl_fc }

backend backend5
mode http
server server5 192.168.0.105:80 check
http-request set-header X-Forwarded-Port %[dst_port]
http-request add-header X-Forwarded-Proto https if { ssl_fc }
#########haproxy.cfg_END#################

The Trick here is “default_backend bk_tcp_to_https” in frontend1 that concatenates all the requests that are not going to be passthrough, to the “backend bk_tcp_to_https”.
It is basically telling if the request is not for aaa.bbb.com or ccc.ddd.com or eee.fff.com, then send it to the default backend, which is himself: 127.0.0.1 but in other port: 8443, and then, Frontend2 is listening in 8443 to take care of the termination of the SSL.

This is the mixed TCP/HTTP combination to passthrough some SSL and terminate others using one single configuration.
#+end_src
* LTE internet
** Parts of the device:
1. [[https://ltefix.com/shop/pcie-m-2/mini-pci-e/usb3-0-to-mini-pci-e-adapter-enclosure-with-sim-card-slot/][This guy]] -  USB3.0 To Mini PCI-E Adapter Enclosure With SIM Card Slot
2. [[https://www.sierrawireless.com/products-and-solutions/embedded-solutions/products/em7455/][this modem]] - Dell Sierra Wireless Airprime EM7455 Qualcomm 4G WWAN Ngff Card KF1W5 1103518 DW5811e
   - Problem with this - turns out to be Dell branded (I did not know that made a difference - though it does now explain why it was so cheap!) so there are things to work on and reset.
   - So how do we make it generic?
     - From [[https://zukota.com/sierra-wireless-em7455-how-to-enable-com-ports/][here]], advice is to (from linux) enable the COM ports so that we can rewrite the firmware and do diagnostics. Need to run a tool to change this - =swi_setusbcomp.pl -usbcomp=8=. So where is this tool?
     - [[https://www.thinkpenguin.com/gnu-linux/em7455-switching-modes-qmi-mbim][this guy's]] got it!  Here's a download link: [[https://www.thinkpenguin.com/files/em7455-modem-software/swi_setusbcomp.pl][link]]. =wget= this from an Ubuntu distro - a server, since it'll be small and we're only doing CLI anyway.
       - side note - how to install VirtualBox Guest Additions in Ubuntu 18.04 server - nice rundown [[https://linuxize.com/post/how-to-install-virtualbox-guest-additions-in-ubuntu/][here]].
       - side note - best way to handle a server VM is honestly to ssh into it!
         - =sudo apt install openssh-server=
         - =sudo systemctl enable ssh=
         - =sudo systemctl start ssh=
         - =sudo systemctl status ssh= to be sure it's up
           then of course:
         - =sudo ufw allow ssh=
         - =sudo ufw enable=
         - =sudo ufw status= to check
         - enable port forwarding in VirtualBox settings:
           - rule name = ssh ; protocol = TCP ; Host port = 2222 ; Guest port = 22 ; Guest IP from VM
         - then can =ssh -p 2222 nick@127.0.0.1=
         - good summary of all this [[https://dev.to/yassineselllami/how-to-ssh-into-ubuntu-vm-virtualbox-from-host-machine-1kii][here]].
     - enable COM ports on EM7455:
       - download =swi_setusbcomp.pl= [[https://www.thinkpenguin.com/files/em7455-modem-software/swi_setusbcomp.pl][here]]
       - =sudo -i= if you feel like it
       - =./swi_setusbcomp.pl -usbcomp=8=
         - may need to do =sudo perl swi_setusbcomp.pl --usbcomp=6= in ubuntu?
         - place this udev rule: [[https://github.com/fribergr/dw5811e/blob/master/99-dell5811e.rules][here]]
         - following [[https://docs.google.com/document/d/1IO-McbflcjJh6h5VCfedOU3P85TsYC1LnAc2JWB3Mk8/mobilebasic][this]] guide
         - find the tty device: =dmesg | grep '.3: Qualcomm USB modem converter detected' -A1 | grep -Eo 'ttyUSB[0-9]$' | tail -1=
           - in this case was =ttyUSB2=
         - =sudo minicom -b 115200 -D /dev/ttyUSB2=
           - AT codes:
             - AT!IMAGE?  checks all firmware and PRIs on module
             - AT!IMPREF?  shows currently used firmware and PRI
             - AT!IMPREF=  allows switching between carriers
             - AT!IMPREF="AUTO-SIM"  seems to set it so that whatever SIM is put in, it will find the right firmware
           - CWE = firmware binaries
            
          
       - after it's done, run =./swi_setusbcomp.pl= again - should return "Current USB composition: 8"
       - then reset the modem to keep it: =./swi_setusbcomp.pl -reset=
     - go [[https://source.sierrawireless.com/resources/airprime/minicard/74xx/airprime-em_mc74xx-approved-fw-packages/][here]]  and download the Generic firmware (on <2020-10-19 Mon> it is [[https://source.sierrawireless.com/-/media/support_downloads/airprime/74xx/fw/7455/swi9x30c_02,-d-,33,-d-,03,-d-,00_generic_002,-d-,072_000.ashx][this]].
     - putting together the current source names, I did this:
       =curl -o SWI9X30C_02.33.03.00_Generic_002.072_000.zip -L https://source.sierrawireless.com/-/media/support_downloads/airprime/74xx/fw/7455/swi9x30c_02,-d-,33,-d-,03,-d-,00_generic_002,-d-,072_000.ashx=
       - Getting various errors, for example  =unexpected response received in dload sdp: 0x13=. Getting this output from
        ~AT!ENTERCND="A710"~
        ~AT!GOBIIMPREF~:
         - 
                 #+begin_src bash
         !GOBIIMPREF:
          preferred fw version:    02.33.03.00
          preferred carrier name:  GENERIC
          preferred config name:   GENERIC_002.072_000
          current fw version:      02.24.05.06
          current carrier name:    US-Cellular
          current config name:     US-Cellular_000.003_000

          fw version mismatch
          carrier name mismatch
          config name mismatch
                 #+end_src

   - =unzip SWI9X30C_02.33.03.00_Generic_002.072_000.zip=

   - need to have Modem Manager: =sudo apt install modemmanager= (also maybe modem-manager-gui?)

   - And then you need to *stop* ModemManager: =sudo systemctl stop ModemManager=

   - But you seem to need it on startup to see the device

   - find out the deviceid: =deviceid=`lsusb | grep -i -E '1199:9071|1199:9079|413C:81B6' | awk '{print $6}'`= (=echo $deviceid= to make sure you got it)

   - Oh wait, there is a hugely comprehensive rundown - [[https://github.com/danielewood/sierra-wireless-modems#basic-setup][this]] GitHub!
     - side note: accessing USB port from within VirtualBox Ubuntu:
       - Install VirtualBox extension pack (all supported platforms): https://www.virtualbox.org/wiki/Downloads (do this while your VM is powered off)
       - this installs the controllers for USB 2.0 and 3.0 (EHCI and xHCI, respectively)

       - Connect your USB thing (in this case the USB enclosure with our Sierra Wireless modem installed - and powered on) 

       - Under the =Settings...= for the VM, =Ports= tab, select =USB=.  Click icon for =Adds new USB filter with all fields set to the values of the selected USB device attached to the host PC= (second one down in VBox 6.1).  Should already be populated with "Sierra Wireless..."

       - Restart

       - Can check to make sure the thing is attached with =lsusb=
     - Let's run his script, which I'll put here: autoflash-7455.sh (will need to have your 7455 in a USB enclosure, which mine fortunately is!) - but the dude is still making active commits, last one on <2020-09-12 Sat>, so keep an eye on the repo.
          #+begin_src bash
     #!/bin/bash
     # shellcheck disable=SC2059
     #
     #.USAGE
     # To start, run:
     # wget https://raw.githubusercontent.com/danielewood/sierra-wireless-modems/master/autoflash-7455.sh && sudo bash autoflash-7455.sh

     #.SYNOPSIS
     # - Only for use on Ubuntu 18 (Bionic) LiveUSB
     # - Changes all models of EM7455/MC7455 Modems to the Generic Sierra Wireless VID/PID
     # - Flashes the Current Generic Firmware

     #.DESCRIPTION
     # - Only for use on Ubuntu 18 (Bionic) LiveUSB
     # - All Needed Packages will Auto-Install
     # - Sets MBIM Mode with AT Commands Access
     # - Changes all models of EM74XX/MC74XX Modems to the Generic Sierra Wireless VID/PID
     # - Clears Band Restrictions and Places Modem in LTE only mode.
     # - Flashes the Current Generic Firmware
     # - Sets PCOFFEN=2 to tell the modem to ignore the W_DISABLE pin sent by many laptop's internal M2 slots.
     # - Sets FASTENUMEN=2 to skip bootloader on warm-boots.
     #   - This, combined with PCOFFEN enables these modems to work in the X1G6/T470 and newer laptops.

     #.NOTES
     # License: The Unlicense / CCZero / Public Domain
     # Author: Daniel Wood / https://github.com/danielewood

     #.LINK
     # https://github.com/danielewood/sierra-wireless-modems

     #.VERSION
     # Version: 20200912

     ##################
     ### Pre-Checks ###
     ##################

     if [ "$EUID" -ne 0 ]
         then echo "Please run with sudo"
         exit
     fi

     lsbrelease=$(lsb_release -c | awk '{print $2}')
     if [ "$lsbrelease" != "bionic" ]
         then echo "Please run on Ubuntu 18 (Bionic)"
         lsb_release -a
         exit
     fi

     #########################
     ### Variables & Input ###
     #########################

     CYAN='\033[0;36m'
     NC='\033[0m' # No Color

     function display_usage() {
       printf "${CYAN}Usage:${NC} $0\n"
       printf "\n"
       printf "${CYAN}Modem Modes:${NC}\n"
       printf " -h    Display usage instructions\n"
       printf " -u    Set AT!USBSPEED\n"
       printf "         0 - High Speed USB 2 ${CYAN}[Default]${NC}\n"
       printf "         1 - SuperSpeed USB 3\n"
       printf " -m    Set AT!USBCOMP\n"
       printf "         8 - MBIM mode (diag,nmea,modem,mbim) ${CYAN}[Default]${NC}\n"
       printf "         6 - QMI mode (diag,nmea,modem,rmnet0)\n"
       printf " -b    Set AT!SELRAT and AT!BAND\n"
       printf "         9 - LTE Only ${CYAN}[Default]${NC}\n"
       printf "         0 - All Bands\n"  
       printf " -e    Set AT!FASTENUMEN\n"
       printf "         0 - Disable fast enumeration\n"
       printf "         1 - Enable fast enumeration for cold boot and disable for warm boot\n"
       printf "         2 - Enable fast enumeration for warm boot and disable for cold boot ${CYAN}[Default]${NC}\n"
       printf "         3 - Enable fast enumeration for warm and cold boot\n"
       printf "\n"
       printf "${CYAN}Script Modes:${NC}\n"
       printf " -a    Enable All Script Functions ${CYAN}[Default]${NC}\n"
       printf "         Same as: $0 -Mgcdfs\n"
       printf " -M    Use swi_setusbcomp.pl to set modem composition\n"
       printf " -g    Display Modem Settings\n"
       printf " -c    Clear Existing Modem Firmwares\n"
       printf " -d    Download and Unpack Modem Firmware from Sierra Wireless\n"
       printf " -f    Flash Modem Firmware\n"
       printf " -s    Change Modem Settings/Modes\n"
       printf " -l    Legacy Stable Firmware\n"
       printf "         Set SWI9X30C_ZIP=\"SWI9X30C_02.30.01.01_GENERIC_002.045_001.zip\"\n"
       printf " -q    Quiet Mode -- suppress most output\n"
       printf " -v    Verbose/Debug Mode\n"
       printf "\n"
       exit 0
     }

     while getopts hu:m:b:e:Mgcdfsalqv option
     do
      case "${option}"
      in
      h) display_usage
           exit 0;;
      u) AT_USBSPEED=${OPTARG};;
      m) AT_USBCOMP=${OPTARG};;
      b) AT_SELRAT=${OPTARG};;
      e) AT_FASTENUMEN=${OPTARG};;
      M) set_swi_setusbcomp_trigger=1;;
      g) get_modem_settings_trigger=1;;
      c) clear_modem_firmware_trigger=1;;
      d) download_modem_firmware_trigger=1;;
      f) flash_modem_firmware_trigger=1;;
      s) set_modem_settings_trigger=1;;
      a) all_functions_trigger=1;;
      l) SWI9X30C_ZIP='SWI9X30C_02.30.01.01_GENERIC_002.045_001.zip';;
      q) quiet_trigger=1;;
      v) verbose_trigger=1;;
      ,*) display_usage>&2
           exit 1;;
       esac
     done


     #################
     ### Functions ###
     #################

     # If no options are set, use defaults of -Mgcdfs
     if [[ -z $get_modem_settings_trigger && -z $clear_modem_firmware_trigger \
         && -z $download_modem_firmware_trigger && -z $flash_modem_firmware_trigger \
         && -z $set_modem_settings_trigger && -z $set_swi_setusbcomp_trigger ]]; then
             all_functions_trigger=1
     fi

     if [[ all_functions_trigger -eq 1 ]]; then
       get_modem_settings_trigger=1
       clear_modem_firmware_trigger=1
       download_modem_firmware_trigger=1
       flash_modem_firmware_trigger=1
       set_modem_settings_trigger=1
       set_swi_setusbcomp_trigger=1
     fi

     function display_variables() {
         echo "AT_USBSPEED=$AT_USBSPEED"
         echo "AT_USBCOMP=$AT_USBCOMP"
         echo "AT_SELRAT=$AT_SELRAT"
         echo "AT_FASTENUMEN=$AT_FASTENUMEN"
         echo "all_functions_trigger=$all_functions_trigger"
         echo "get_modem_settings_trigger=$get_modem_settings_trigger"
         echo "clear_modem_firmware_trigger=$clear_modem_firmware_trigger"
         echo "download_modem_firmware_trigger=$download_modem_firmware_trigger"
         echo "flash_modem_firmware_trigger=$flash_modem_firmware_trigger"
         echo "set_modem_settings_trigger=$set_modem_settings_trigger"
         echo "set_swi_setusbcomp_trigger=$set_swi_setusbcomp_trigger"
         echo "SWI9X30C_CWE=$SWI9X30C_CWE"
         echo "SWI9X30C_NVU=$SWI9X30C_NVU"
         echo "AT_PRIID_STRING=$AT_PRIID_STRING"
         echo "AT_PRIID_PN=$AT_PRIID_PN"
         echo "AT_PRIID_REV=$AT_PRIID_REV"
     }

     function set_options() {
         # See if QMI desired, otherwise default to MBIM
         if [[ ${AT_USBCOMP^^} =~ ^QMI$|^6$ ]]; then
             echo 'Setting QMI Mode for Modem'
             echo 'Interface bitmask: 0000010D (diag,nmea,modem,rmnet0)'
             AT_USBCOMP="1,1,0000010D"
             swi_usbcomp='6'
         else
             echo 'Setting MBIM Mode for Modem'
             echo 'Interface bitmask: 0000100D (diag,nmea,modem,mbim)'
             AT_USBCOMP="1,1,0000100D"
             swi_usbcomp='8'
         fi

         # Check for ALL/00 bands and set correct SELRAT/BAND, otherwise default to LTE
         if [[ ${AT_SELRAT^^} =~ ^ALL$|^0$|^00$ ]]; then
             AT_SELRAT='00'
             AT_BAND='00'
         else
             AT_SELRAT='06'
             AT_BAND='09'
         fi

         # Check if valid FASTENUMEN mode, otherwise default to 2
         if [[ ! $AT_FASTENUMEN =~ ^[0-3]$ ]]; then
             AT_FASTENUMEN=2
         fi

         #FASTENUMEN_MODES="0 = Disable fast enumeration [Default]
         #1 = Enable fast enumeration for cold boot and disable for warm boot
         #2 = Enable fast enumeration for warm boot and disable for cold boot
         #3 = Enable fast enumeration for warm and cold boot"
         #echo '"FASTENUMEN"—Enable/disable fast enumeration for warm/cold boot.'
         #echo -n 'Set mode: ' && echo "$FASTENUMEN_MODES" | grep -E "^$AT_FASTENUMEN"

         # Check desired USB interface mode, otherwise default to 0 (USB 2.0)
         if [[ ${AT_USBSPEED^^} =~ SUPER|USB3|1 ]]; then
             AT_USBSPEED=1
         else
             AT_USBSPEED=0
         fi
     }

     function get_modem_deviceid() {
         deviceid=''
         while [ -z $deviceid ]
         do
             echo 'Waiting for modem to reboot...'
             sleep 3
             deviceid=$(lsusb | grep -i -E '1199:9071|1199:9079|413C:81B6' | awk '{print $6}')
         done
         sleep 3
         ttyUSB=$(dmesg | grep '.3: Qualcomm USB modem converter detected' -A1 | grep -Eo 'ttyUSB[0-9]$' | tail -1)
         devpath=$(find /dev -maxdepth 1 -regex '/dev/cdc-wdm[0-9]' -o -regex '/dev/qcqmi[0-9]')
     }

     function reset_modem {
         # Reset Modem
         printf "${CYAN}---${NC}\n"
         echo 'Reseting modem...'
         ./swi_setusbcomp.pl --usbreset --device="$devpath" &>/dev/null
     }

     function get_modem_settings() {
         # cat the serial port to monitor output and commands. cat will exit when AT!RESET kicks off.
         sudo cat /dev/"$ttyUSB" 2>&1 | tee -a modem.log &  

         # Display current modem settings
         printf "${CYAN}---${NC}\n"
         echo 'Current modem settings:'
         echo 'send AT
     send ATE1
     sleep 1
     send ATI
     sleep 1
     send AT!ENTERCND=\"A710\"
     sleep 1
     send AT!IMPREF?
     sleep 1
     send AT!GOBIIMPREF?
     sleep 1
     send AT!USBSPEED?
     sleep 1
     send AT!USBSPEED=?
     sleep 1
     send AT!USBCOMP?
     sleep 1
     send AT!USBCOMP=?
     sleep 1
     send AT!USBVID?
     sleep 1
     send AT!USBPID?
     sleep 1
     send AT!USBPRODUCT?
     sleep 1
     send AT!PRIID?
     sleep 1
     send AT!SELRAT?
     sleep 1
     send AT!BAND?
     sleep 1
     send AT!BAND=?
     sleep 1
     send AT!PCINFO?
     sleep 1
     send AT!PCOFFEN?
     sleep 1
     send AT!CUSTOM?
     sleep 1
     send AT!IMAGE?
     sleep 1
     ! pkill cat
     sleep 1
     ! pkill minicom
     ' > script.txt
         sudo minicom -b 115200 -D /dev/"$ttyUSB" -S script.txt &>/dev/null
     }

     function clear_modem_firmware() {
         # cat the serial port to monitor output and commands. cat will exit when AT!RESET kicks off.
         sudo cat /dev/"$ttyUSB" 2>&1 | tee -a modem.log &  
         # Clear Previous PRI/FW Entries
         echo 'send AT
     send AT!IMAGE=0
     sleep 1
     send AT!IMAGE?
     sleep 1
     ! pkill cat
     sleep 1
     ! pkill minicom
     ' > script.txt
         sudo minicom -b 115200 -D /dev/"$ttyUSB" -S script.txt &>/dev/null
     }

     function download_modem_firmware() {
         # Find latest 7455 firmware and download it
         if [[ -z $SWI9X30C_ZIP ]]; then
             SWI9X30C_ZIP=$(curl https://source.sierrawireless.com/resources/airprime/minicard/74xx/airprime-em_mc74xx-approved-fw-packages/ 2> /dev/null | grep PTCRB -B1 | sed 's/,-d-,/./g' | grep -iEo '7455/swi9x30c[_0-9.]+_generic_[_0-9.]+' | cut -c 6- | tail -n1)
             SWI9X30C_ZIP="${SWI9X30C_ZIP^^}"'zip'
         fi
         SWI9X30C_URL='https://source.sierrawireless.com/~/media/support_downloads/airprime/74xx/fw/7455/'"$SWI9X30C_ZIP"

         SWI9X30C_LENGTH=$(curl -sI "$SWI9X30C_URL" | grep -i Content-Length | grep -Eo '[0-9]+')

         # If remote file size is less than 40MiB, something went wrong, exit.
         if [[ $SWI9X30C_LENGTH -lt 40000000 ]]; then
             printf "${CYAN}---${NC}\n"
             printf "Download of ${CYAN}$SWI9X30C_ZIP${NC} failed.\nFile size on server is too small, something is wrong, exiting...\n"
             printf "Attempted download URL was: $SWI9X30C_URL\n"
             printf "curl info:\n"
             curl -sI "$SWI9X30C_URL"
             printf "${CYAN}---${NC}\n"
             exit
         fi

         if [[ $SWI9X30C_LENGTH -eq $(stat --printf="%s" "$SWI9X30C_ZIP" 2>/dev/null) ]]; then
             echo "Already downloaded $SWI9X30C_ZIP..."
         else
             echo "Downloading $SWI9X30C_URL"
             curl -o "$SWI9X30C_ZIP" "$SWI9X30C_URL"
         fi

         # If download size does not match what server says, exit:
         if [[ $SWI9X30C_LENGTH -ne $(stat --printf="%s" "$SWI9X30C_ZIP" 2>/dev/null) ]]; then
             printf "${CYAN}---${NC}\n"
             printf "Download of ${CYAN}$SWI9X30C_ZIP${NC} failed.\nDownloaded file size is inconsistent with server, exiting...\n"
             printf "${CYAN}---${NC}\n"
             exit
         fi

         # Cleanup old CWE/NVUs
         rm -f ./*.cwe ./*.nvu 2>/dev/null
    
         # Unzip SWI9X30C, force overwrite
         unzip -o "$SWI9X30C_ZIP"
     }

     function flash_modem_firmware() {
         # Kill cat processes used for monitoring status, if it hasnt already exited
         sudo pkill -9 cat &>/dev/null

         printf "${CYAN}---${NC}\n"
         echo "Flashing $SWI9X30C_CWE onto Generic Sierra Modem..."
         sleep 5
         qmi-firmware-update --update -d "$deviceid" "$SWI9X30C_CWE" "$SWI9X30C_NVU"
         rc=$?
         if [[ $rc != 0 ]]
         then
             echo "Firmware Update failed, exiting..."
             exit $rc
         fi
     }

     function set_modem_settings() {
         # cat the serial port to monitor output and commands. cat will exit when AT!RESET kicks off.
         sudo cat /dev/"$ttyUSB" 2>&1 | tee -a modem.log &  

         # Set Generic Sierra Wireless VIDs/PIDs
         cat <<EOF > script.txt
     send AT
     send ATE1
     sleep 1
     send ATI
     sleep 1
     send AT!ENTERCND=\"A710\"
     sleep 1
     send AT!IMPREF=\"GENERIC\"
     sleep 1
     send AT!GOBIIMPREF=\"GENERIC\"
     sleep 1
     send AT!USBCOMP=$AT_USBCOMP
     sleep 1
     send AT!USBVID=1199
     sleep 1
     send AT!USBPID=9071,9070
     sleep 1
     send AT!USBPRODUCT=\"EM7455\"
     sleep 1
     send AT!PRIID=\"$AT_PRIID_PN\",\"$AT_PRIID_REV\",\"Generic-Laptop\"
     sleep 1
     send AT!SELRAT=$AT_SELRAT
     sleep 1
     send AT!BAND=$AT_BAND
     sleep 1
     send AT!CUSTOM=\"FASTENUMEN\",$AT_FASTENUMEN
     sleep 1
     send AT!PCOFFEN=2
     sleep 1
     send AT!PCOFFEN?
     sleep 1
     send AT!USBSPEED=$AT_USBSPEED
     sleep 1
     send AT!USBSPEED?
     sleep 1
     send AT!USBSPEED=?
     sleep 1
     send AT!CUSTOM?
     sleep 1
     send AT!IMAGE?
     sleep 1
     send AT!PCINFO?
     sleep 1
     send AT!RESET
     ! pkill minicom
     EOF
         sudo minicom -b 115200 -D /dev/"$ttyUSB" -S script.txt &>/dev/null
     }

     function script_prechecks() {
         printf "${CYAN}---${NC}\n"
         echo 'Searching for EM7455/MC7455 USB modems...'
         modemcount=$(lsusb | grep -c -i -E '1199:9071|1199:9079|413C:81B6')
         while [ "$modemcount" -eq 0 ]
         do
             printf "${CYAN}---${NC}\n"
             echo "Could not find any EM7455/MC7455 USB modems"
             echo 'Unplug and reinsert the EM7455/MC7455 USB connector...'
             modemcount=$(lsusb | grep -c -i -E '1199:9071|1199:9079|413C:81B6')
             sleep 3
         done

         printf "${CYAN}---${NC}\n"
         echo "Found EM7455/MC7455: 
         $(lsusb | grep -i -E '1199:9071|1199:9079|413C:81B6')
         "

         if [ "$modemcount" -gt 1 ]
         then 
             printf "${CYAN}---${NC}\n"
             echo "Found more than one EM7455/MC7455, remove the one you dont want to flash and try again."
             exit
         fi

         # Stop modem manager to prevent AT command spam and allow firmware-update
         printf "${CYAN}---${NC}\n"
         echo 'Stoping modem manager to prevent AT command spam and allow firmware-update, this may take a minute...'
         systemctl stop ModemManager
         systemctl disable ModemManager

         printf "${CYAN}---${NC}\n"
         echo "Installing all needed prerequisites..."
         add-apt-repository universe 1>/dev/null
         apt update -y
         # need make and GCC for compiling perl modules
         apt-get install make gcc curl minicom libqmi-glib5 libqmi-proxy libqmi-utils -y
         # Use cpan to install/compile all dependencies needed by swi_setusbcomp.pl
         yes | cpan install UUID::Tiny IPC::Shareable JSON

         # Install Modem Mode Switcher
         if [ ! -f swi_setusbcomp.pl ]; then
             wget https://git.mork.no/wwan.git/plain/scripts/swi_setusbcomp.pl
         fi
         chmod +x ./swi_setusbcomp.pl

         reset_modem
     }

     function set_swi_setusbcomp() {
         # Modem Mode Switch to usbcomp=8 (DM   NMEA  AT    MBIM)
         printf "${CYAN}---${NC}\n"
         echo "Running Modem Mode Switch to usbcomp=$swi_usbcomp"
         ./swi_setusbcomp.pl --usbcomp=$swi_usbcomp --device="$devpath"
         reset_modem
     }

     function script_cleanup() {
         # Restart ModemManager
         systemctl enable ModemManager &>/dev/null
         systemctl start ModemManager &>/dev/null

         echo "Done!"

         # Kill cat processes used for monitoring status, if it hasnt already exited
         sudo pkill -9 cat &>/dev/null
     }

     ########################
     ### Script Execution ###
     ########################

     if [[ $quiet_trigger ]]; then
         script_prechecks &>/dev/null
     else
         script_prechecks
     fi

     set_options

     devpath=$(find /dev -maxdepth 1 -regex '/dev/cdc-wdm[0-9]' -o -regex '/dev/qcqmi[0-9]')

     if [[ $set_swi_setusbcomp_trigger ]]; then
         set_swi_setusbcomp
     fi

     get_modem_deviceid

     [[ $get_modem_settings_trigger ]] && get_modem_settings

     if [[ $clear_modem_firmware_trigger ]]; then
       clear_modem_firmware
       get_modem_deviceid
     fi

     [[ $download_modem_firmware_trigger ]] && download_modem_firmware

     SWI9X30C_CWE=$(find . -maxdepth 1 -type f -iregex '.*SWI9X30C[0-9_.]+\.cwe' | cut -c 3- | tail -n1)
     SWI9X30C_NVU=$(find . -maxdepth 1 -type f -iregex '.*SWI9X30C[0-9_.]+generic[0-9_.]+\.nvu' | cut -c 3- | tail -n1)

     AT_PRIID_STRING=$(strings "$SWI9X30C_NVU" | grep '^9999999_.*_SWI9X30C_' | sort -u | head -1)
     AT_PRIID_PN="$(echo "$AT_PRIID_STRING" | awk -F'_' '{print $2}')"
     AT_PRIID_REV="$(echo "$AT_PRIID_STRING" | grep -Eo '[0-9]{3}\.[0-9]{3}')"

     [[ $flash_modem_firmware_trigger ]] && flash_modem_firmware
     [[ $set_modem_settings_trigger ]] && set_modem_settings
     [[ $verbose_trigger ]] && display_variables

     script_cleanup

     # Done
          #+end_src

       - since it's being updated, probably best to run this (may need to install =unzip= first, I did on Ubuntu 18.04, weirdly):
           wget https://raw.githubusercontent.com/danielewood/sierra-wireless-modems/master/autoflash-7455.sh && sudo bash autoflash-7455.sh

       - But since we are good, security-conscious Linux users, we won't do that - download it and look it over first!

       - <2020-10-19 Mon> getting errors right at end of script.  Trying manually.

** Router to handle the connection
- in an ideal world, would just bea able to connec the LTE modem to a device, but - there seem to be issues with drivers and compatibility so it might be easier to have something in front.  Also better if other devices will attach to that signal.  /Also/ because we want to get some kind of info back from the modem, stats on connection etc.  [[https://ofmodemsandmen.com/][GoldenOrb / ROOter]] would be best, but need a compatible router which I don't have right now.  DO have a Raspberry Pi though!  Since GoldenOrb is based on OpenWrt, how about OpenWrt for RPi?
*** *OpenWrt for RPi4*, community build.  Here is the [[https://forum.openwrt.org/t/rpi4-community-build/69998][thread]] for the community build of OpenWrt for RPi4, leading to [[https://github.com/wulfy23/rpi4][this]] Github.
**** Installing:
- download, put factory version on flash drive:
  =gzcat rpi4.64-snapshot-23290-1.9.15-29-r14315-ext4-fac.img.gz | dd of=/dev/disk2; sync=
      

  
     
* Resizing (shrinking) a partition
** resize2fs first
- boot on USB or something
  - (for Hetzner, boot in rescue mode)
- =lsblk= to make sure you know what's what
- =e2fsck= the partition first to make sure it's OK
- then (example) =resize2fs -p /dev/sdb3 120G=
** then =parted= / =resizepart=
- =parted /dev/sdb=
  - find partition numbers with =print=
  - (parted) =resizepart=
    - partition number? 3
    - End?  [256GB]? 120
* making a new partition with the space that's left
** =parted /dev/sdb print unit MB print free=
- starts at =140000MB=
** can run =gparted= through x11 by =sudo -E gparted= (after logging in with =-X= obvs)
* Backing up
** <2020-09-24 Thu> Not the best long-term thing, but
- for a quick incremental image using =rsnapshot=.
- NOTE: in rsnapshot.conf, /need/ to use TABs
- To avoid backing up mounted drives as well, in =/etc/rsnapshot.conf= changed line to:
  - =backup  /             localhost/rootfs one_fs=1=
  - (this backs up the root directory but stays in the same filesystem)
- check configuration: (needs to be =sudo= if backing up root fs):
  - =sudo rsnapshot configtest=
- Dry run:
  - =rsnapshot -t daily=
- As long as daily has been set up in config, then back up with
  - =sudo rsnapshot daily=
- Maybe this little tidbit in the man page was why it kept copying my mounted media files anyway:
  - a ’*’ matches any path component, but it stops at slashes
    use ’**’ to match anything, including slashes.
- in =rsnapshot.conf= put in line: =exclude         /mnt/**=
* Traefik
** generating password to go into =.htpasswd=:
#+begin_src bash
echo $(htpasswd -nb user password) | sed -e s/\\$/\\$\\$/g

htpasswd -b -c ~/temp/password admin test101

#+end_src

* Securing email: Protonmail / Linode
** DKIM
*** the dilemma:
- for pm DKIM, needed to add CNAME to DNS records, but I couldn't figure out how to do what =pm= wanted in the Linode web GUI, os I turned to the =linode-cli= (which is at [[https://github.com/linode/linode-cli][this GitHub]])
*** the solution:
**** used linode-cli to access the api
- on mac, installed linode-cli by =pip3 install linode-cli=. Then, install a personal token.
- then spent a while looking through the documentation (minimal) and finally found a format to mimic in the issues section on the GitHub
- this command worked:
  - ~linode-cli domains records-create 1310801 --type CNAME --name protonmail._domainkey --target="protonmail.domainkey.df32r4c5vqmpn3ofc5lbx2zpf7s7nitj2hcek6dch5swftnipoega.domains.proton.ch"~
  - (of course you have to put in three different versions, with the =--name= incrementing)
  - =1310801= is the id for =fob.monster= obtained through =linode-cli domains list=
  - the =--name= and the =--target= are from the variables that ProtonMail gives you
  - put in the =--debug= flag to get more verbose errors (or successes!)
  - An important thing here that kept screwing me up: PM gives you a value for the CNAME that ends in a =.= -- this is what kept getting rejected by the Linode API.  Strip the period.
* Looking around for new dedicated server
** Hetzner:
*** speeds over MTR from VA to Nuremberg center (10 pkts)

| time    | server               | Loss% | Snt | Last | Avg  | Best |  Wrst | StDev |
|---------+----------------------+-------+-----+------+------+------+-------+-------|
| 3pm     | nbg.icmp.hetzner.com |  0.0% |  10 |  7.0 | *19.6* |  4.6 | 110.7 |  32.4 |
| 11pm    | nbg.icmp.hetzner.com |  0.0% |  10 | 10.8 | *8.3*  |  5.1 |  11.7 |   2.5 |
| 11:30pm | nbg.icmp.hetzner.com |  0.0% |  10 | 13.4 | *10.9* |  5.8 |  27.9 |   6.6 |
|---------+----------------------+-------+-----+------+------+------+-------+-------|


*** speeds over MTR from VA to Falkenstein:(10 pkts)

| time    | server               | Loss% | Snt | Last | Avg  | Best |  Wrst | StDev |
|---------+----------------------+-------+-----+------+------+------+-------+-------|
| 3pm     | fsn.icmp.hetzner.com |  0.0% |  10 | 13.5 | *22.8* |  7.3 | 104.9 |  29.4 |
| 11pm    | fsn.icmp.hetzner.com |  0.0% |  10 | 11.3 | *9.6*  |  4.5 |  14.3 |   2.8 |
| 11:30pm | fsn.icmp.hetzner.com |  0.0% |  10 |  2.8 | *13.6* |  2.8 |  61.7 |  17.5 |
|---------+----------------------+-------+-----+------+------+------+-------+-------|


*** speeds over MTR from VA to Helsinki:(10 pkts)

| time    | server               | Loss% | Snt | Last | Avg  | Best | Wrst | StDev |
|---------+----------------------+-------+-----+------+------+------+------+-------|
| 3pm     | hel.icmp.hetzner.com |  0.0% |  10 | 12.3 | *10.4* |  6.1 | 20.0 |   3.8 |
| 11pm    | hel.icmp.hetzner.com |  0.0% |  10 |  4.2 | *9.1*  |  3.3 | 19.9 |   5.9 |
| 11:30pm | hel.icmp.hetzner.com |  0.0% |  10 |  7.2 | *11.2* |  3.1 | 42.8 |  11.6 |
|---------+----------------------+-------+-----+------+------+------+------+-------|

** Reprise hosting:
*** speeds over MTR from VA to Reprise (10 pkts avg)

| time    |          server | Loss% | Snt | Last | Avg  | Best | Wrst | StDev |
|---------+-----------------+-------+-----+------+------+------+------+-------|
| 3pm     | 162.253.153.104 |  0.0% |  10 | 11.9 | *14.5* |  6.9 | 37.2 |   8.5 |
| 11:30pm | 163.253.153.104 |  0.0% |  10 | 12.3 | *16.3* |  9.0 | 33.7 |   8.4 |
| 12:30am | 164.253.153.104 |  0.0% |  10 |  9.2 | *8.0*  |  3.1 | 13.9 |   3.0 |
|---------+-----------------+-------+-----+------+------+------+------+-------|

* Setting up Hetzner server
** [[https://robot.your-server.de/server][Robot address]]
** SSD and HDD
Eventually figured out how to put OS on SSD.  On first =installimage= comment out all drives but SSD, change SSD name to =DISK1=
*** However,
- doesn't boot right. What I would like is to have the OS boot off of the SSD. I want the HDDs to just be file storage.  Working from [[https://hostedtalk.net/t/hetzner-setting-additional-ssd-as-boot/1865/13][this]] discussion, started over.
- The issue with my server is that the SSD is locared at sdc instead of sda, so you gotta do all kinds of tricky things to tget it to boot first.  Which are detailed here:
*** remove all partitions using =parted=
- all you need to do is make a new partition table, and everything prior is erased
*** using =installimage=, commented out HDDs and changed SSD name to DISK1
- so, installed ubuntu to SSD
- (changed SWRAID to 0)
*** first steps:
- create a small (~10MB) partition on each 3TB disk, type set to bios boot:
  - using =gdisk=:
    - for bios-boot partition
      - =<n>= - new partition
      - =<enter>= - first available sector
      - =+10M= - 10MiB in size
      - type: =ef02= - bios boot
    - for rest
      - =<n>= - new partition
      - =<enter>= - first available sector
      - =-0= - to end
      - type: =8300= - linux file system
  - =w= to write and quit when done
*** then, root partition appears to be =/dev/sdc3=
- boot partition appears to be =/dev/sdc2/=
- so:
  1. =mount /dev/sdc3 /mnt=
  2. =mount /dev/sdc2 /mnt/boot=
- this way both root and boot partitions are mounted
*** bind mount dev/proc/sys into root-partition
- =for f in proc sys dev ; do mount --bind /$f /mnt/$f ; done=
- =chroot /mnt /bin/bash=
- =grub-install /dev/sda=
- =grub-install /dev/sdb=
- =update-grub=
- =reboot=
*** Holy shit that worked!
*** However, still no file system
- In both fdisk and gdisk, partitions are made without file systems, so
  - =mkfs.ext4 /dev/sdb2= for example
  - This worked for both of them
*** Setting up mount points and fstab:
- mounted sda2 at /mnt/driveA, sdb2 at /mnt/driveB
- made a =data= group to own them
- =sudo usermod -aG data USERNAME= to add users to the group
- used =chmod g+s .;= to (hopefully) sets the group id (setgid) on the current directory, which should mean that new files will inherit the ownership - even if copied (but not if moved)
filebot -rename . --db TheTVDB  --lang en --order DVD --mode interactive=
* Helping with mom's computer
** <2020-09-07 Mon> Fixed:
- Showed her how to put bookmarks in bookmarks bar, worked on those
- Cleaned up notification bar pinned apps
- Now, the Vhrome that is pinned there will open up signed into her account (or should!)
- Jumbled-looking text on Google Chrome but fine in other browsers (tried Firefox and Edge)
  - tried:
    - Turning on / off hardware acceleration in Google Chrome
    - Turning on / off TrueText
  - worked: For some reason, signing her back into her Google account fixed the problem
- Updated: Still on 1909, 2004 update not yet available and per people in Reddit worth skipping
  - Allowed Windows Update to do its thing, there were things that it was updating within 1909
  - Waiting to see how that worked
- Pending: For some reason, her desktop is not the nice blank slate I would want it to be - it's almost like some of the start button options are always on top.  Also her wallpaper keeps disappearing (though that might have to do with me signing in with TeamViewer)
* Setting up advance directives in Virginia
** Some things to think about at the beginning:
- So, you want to put something together so that you might have some degree of control over the things that happen to you in a hospital if you are unable to communicate or express your wants or needs.  That is a pretty good idea!  Here are some suggestions for how to go about this.

  The document you want to have produced at the end of all this goes by a bunch of different names, depending on where you live and depending on what your exact use of it will be.  It is most commonly called a "living will" or "health care advance directive."  It is sometimes called a "durable power of attorney for health care."  As the American Bar Association (ABA) says in its [[https://www.americanbar.org/groups/law_aging/resources/health_care_decision_making/consumer_s_toolkit_for_health_care_advance_planning/][discussion of this topic]]:

  #+begin_quote
  "Studies have shown that standard advance directive forms do little to influence end-of-life decisions without: (1) informed, thoughtful reflection about your wishes and values, and (2) personal communication between you and your likely decision-makers before a crisis occurs."
  #+end_quote

- In other words, it is important and good to have a piece of paper or electronic document that clearly states your wishes and desires for the kind of medical treatment you would like to receive when you are unable to express that choice.  It is also important to remember that this will only be a piece of paper (or a collection of 1s and 0s) - it can be and sometimes is ignored by medical practitioners.
  
  This means: the most important part of the advance directive that you fill out will be the very first section, the one that designates your health care proxy.  It is important to designate a health care proxy, and to have a thorough discussion with that person about the things that you would like or not like to have done during a health care crisis.  Your health care proxy could be anyone, but they should be a person that you trust to be able to carry out this role.  If you have family members who might get involved in making a health care decision for you, it is important to inform them that you have a health care proxy who will be formally designated to make those decisions for you.  In fact, you should tell the important people in your life about this the moment you do it!

  A quick aside - most people associate these documents and discussions and preparations with "end-of-life" things.  You know, deciding who will "pull the plug" on you or other morbid considerations.  Please remember that there can be plenty of situations in which you might be hospitalized, unable to communicate, but with every chance of recovery.  This is stil la situation in which having a health care proxy and a set of written advance directives will be useful.

  OK, those are just some preamble-type suggestions.  Keep them in mind.
** Starting with the process:
- A good place to begin is the American Bar Association's Tool Kit for Health Care Advance Planning (found [[https://www.americanbar.org/groups/law_aging/resources/health_care_decision_making/consumer_s_toolkit_for_health_care_advance_planning/][here]]).  This walks you through some of the steps you need to think through when you are starting down this road.  This is a good place to start reading if you might still have some un certainty about what exactly you are getting yourself into.
** Then,
Once you've looked that over (or if you already think you know what you are doing!), the best place to get started with the specifics starts on the Virginia State Bar's page on healthcare decision-making (which is [[https://www.vsb.org/site/public/healthcare-decisions-day][right here]]).
  - That page has links to the most current versions of the forms you need to fill out, in PDF form (and with the fields set up in the PDF, so easier to fill out on your computer).
    - There are "short" and "full" versions of these forms - it doesn't look to me like the "full" versions add anything important, so I'd stick with the short versions.
    - Remember that as long as you have signed the form and had that signature witnessed, you can fill out as much or as little of the form as you want.  If all you want to do is designate a health care proxy, then fill out that part.  That's all you need.
  - Part C, on the second page of the short form, can be a little confusing for people.  It is the only part of the document in which you would need the signature of a licensed professional, but it only covers a particular situation: one in which you might object to a needed medical treatment, an objection you might not make in a better, healthier frame of mind.  *Section C* allows your health care proxy to make a health care decision for you over your explicit objection.  If you want to cover this situation in your advance directive, then get a licensed professional to sign this part for you.
  - The Virginia State Bar page also has a link to the [[https://connectvirginia.org/adr][Virginia Advance Health Care Directives Registry]] (VAHCDR) which is where you are able to securely store your directive forms.
    - Once you have created an account on the VAHDCR and stored your documents there, you can print out a wallet card to carry with you, which will allow people to access the VAHDCR and look up your stuff.
** So here's an outline of the process you might follow:
1) Read the ABA's tool kit [[https://www.americanbar.org/groups/law_aging/resources/health_care_decision_making/consumer_s_toolkit_for_health_care_advance_planning/][here]].
2) Think about who you would like to choose as your health care proxy.
3) Talk to that person, and plan to have a full and honest discussion about the kinds of medical care you want / don't want.  Be specific!  This is not a conversation in which you want to avoid talking about painful, awful things.  This is a conversation about painful and awful things, so just do that.
4) Download one of the forms from the [[https://www.vsb.org/site/public/healthcare-decisions-day][Virginia State Bar's Healthcare Decisions page]].  I suggest the [[https://www.vsb.org/sections/hl/Virginia_AD_Medical_Mental_End-of-Life_Healthcare_short.pdf][short version]] (<-- you can *right click* on that link, and "save as" a document to your computer).
5) Read the gray column on the left of each page of the form, as it has a pretty good explanation of the stuff you are filling out.
6) Remember that you can fill out as much or as little as you want - as long as you sign it and have the signature witnessed, the document is good.  Some people might, at the beginning, only want to designate a health care proxy.  That's fine!
7) Print out multiple copies and sign them.  Multiple copies, because it is good to have a few around, and you should be distributing them to (at least) your primary care physician and your health care proxy, as well as (possibly) some family members.  The important thing is that, if you were to end up in the hospital, it should not be too difficult to convey a copy of that form to the people caring for you in the hospital.  To that end, the next few steps will help:
8) Make an account at the [[https://connectvirginia.org/adr][Virginia Advance Health Care Directives Registry]] (VAHCDR).
9) Scan a signed copy of you advance directive, or electronically sign the digital version, and upload it to the VAHDCR.
10) Print out a wallet card to carry with you - this will allow people to access the electronic version of your advance directive.  This means that, even if you cannot communicate, there is a good chance the hospital will be able to find out who your health care proxy is and what your health care desires are.

I think that's pretty much it!

* Volvo
** Gas

#+NAME: mileage
| date             | mileage | gallons filled | miles travelled |       mpg |
|------------------+---------+----------------+-----------------+-----------|
| <2020-09-27 Sun> |  204940 |         10.932 |                 |           |
| <2020-10-04 Sun> |  205255 |         12.657 |             315 | 24.887414 |
|                  |         |                |                 |           |

#+TBLFM: @3$4=(@$-2)-(@-1$-2)
#+TBLFM: @3$5=((@$-3)-(@-1$-3))/(@$-2)

* COVID-19
** lay articles
*** [[https://www.sciencemag.org/news/2020/05/why-do-some-covid-19-patients-infect-many-others-whereas-most-don-t-spread-virus-all][AAAS - /Science/ magazine]] <2020-05-19 Tue> - one of the first discussions of clustering, bringing some reports together.  Discusses /k/ vs R.  Discussion of what characteristics of particular individuals might cause them to become super-spreaders.  "Most people do not transmit."  Droplets vs aerosols / airborne.  Some people shed more virus due to the stage / method  of infection, some people emit more droplets than others when talking, somewhat related to volume (Asadi et al 2019).
*** [[https://www.theatlantic.com/health/archive/2020/09/k-overlooked-variable-driving-pandemic/616548/][Atlantic article]] <2020-09-30 Wed> - discusses /k/ and clustering, super-spreading events and the proper kinds of governmental response to reduce infections

* Recipes
** Easy Banana Magic Cake
*** Ingredients
**** 1/2 cup unsalted butter-melted and slightly cooled
**** 1 Tablespoon water
**** 2 cups milk-lukewarm
**** 4 eggs-separated
**** ¾ cup sugar
**** 2 tablespoons light brown sugar
**** ½ cup mashed banana (1 medium banana)
**** 1 cup flour
**** 1 teaspoon vanilla extract
**** powdered sugar for dusting

*** Instructions

1) Preheat the oven to 325°F. Lightly grease 8×8 inch baking dish, set aside (you can line it with parchment paper leaving the sides overhang the pan, it will be easier to serve, you can lift the cake and transfer plate).
2) Whip the egg whites until STIFF peaks form, set aside.
3) Beat the egg yolks and sugars until pale yellow.
4) Mix in melted butter and the tablespoon of water (for about 2 minutes) until evenly combined.
5) Mix in mashed banana just to combine.
6) Mix in flour until evenly incorporated.
7) Slowly beat in the milk and vanilla extract until well combined.
8) Fold in the egg whites (1/3 at a time, then repeat until all of the egg whites are folded in). NOTES: The batter is very, very
 thin!!!
9) Pour the batter into the pan and bake for 45-60 minutes (until the cake is barely jiggly in the center). Baking time might vary depending on your oven or pan you use, but start checking after 45 minutes. If the top browns quickly before the minimum of 45 minutes, you can cover the cake with aluminum foil.
10) Cool the cake completely before dusting with powdered sugar. Even cooled, it will be slightly jiggly because it has custard layer in the center!

* Upgrading Windows 7 to 10
** /over/ Windows 7:
- try https://www.microsoft.com/en-gb/software-download/windows10
* Digitizing CDs
** http://exactaudiocopy.de/
** [[https://www.foobar2000.org/][foobar2000]] supports ripping CDs: https://www.foobar2000.org/FAQ#converting_audio_files_to_different_file_formats
** Where to store / play them?
- [[https://asti.ga/][Astiga]] lets you keep your files in the cloud - has web and phone apps
* Pasting stuff for scripts:
** Halfway through setting up Jitsi in an LXC, just gonna paste all the commands (with context) I enter, so I can think about puting stuff into a bash script later:
*** code:
- =lxc exec debian -- /bin/bash=
- from =/etc/nginx/sites-enabled/default= take the virtual host configuration example  at the bottom of the file, whch is this:
  #+begin_src bash
# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#       listen 80;
#       listen [::]:80;
#
#       server_name example.com;
#
#       root /var/www/example.com;
#       index index.html;
#
#       location / {
#               try_files $uri $uri/ =404;
#       }
#}
  #+end_src
- change it to this (for this particular case):
#+begin_src bash
# Virtual Host configuration for meet.frankiesaurus.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#       listen 80;
#       listen [::]:80;
#
#       server_name frankiesaurus.com;
#
#       root /var/www/frankiesaurus.com;
#       index index.html;
#
#       location / {
#               try_files $uri $uri/ =404;
#       }
#}
#+end_src
- paste this into new files in =/etc/nginx/sites-enabled=, keeping =server_name= the same but changing where =root= is pointing:
  - =frankiesaurus.com= - =root /var/www/frankiesaurus.com=
  - =matrix.frankiesaurus.com= - =root /var/www/matrix.frankiesaurus.com=
    - for =matrix.frankiesaurus.com= replace =location= block with =proxy_pass http://localhost:8008=
  - =element.frankiesaurus.com= - =root /var/www/element.frankiesaurus.com=
- then =apt install -y python3-certbot-nginx && certbot --nginx -d frankiesaurus.com -d riot.frankiesaurus.com -d matrix.frankiesaurus.com=
  - (need to enter email, (A)gree, (Y)es
- for now, still haven't set up with HAProxy so certs did not go through.
* unconnected (for now) notes:
** completely remove nginx, including config files
apt-get purge nginx nginx-common
** list packages expressly installed by user (not incl dependencies)
- aptitude search '~i!~M'
- apt list --manual-installed

** emacs spelling
- currently <2020-10-18 Sun> spelling is through ispell, so file with added words is at =~/.ispell_english=
